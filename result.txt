import asyncio
import ctypes
import json
import logging
import multiprocessing as mp
import os
import platform
import secrets
import signal
import sys
import time
from dataclasses import dataclass
from multiprocessing.process import BaseProcess
from pathlib import Path
from typing import Any, Dict, List, Optional

# Allow using bundled websocket libraries under pyrun/libs without pip install.
LIBS_DIR = Path(__file__).resolve().parent / "libs"
if LIBS_DIR.exists():
    sys.path.append(str(LIBS_DIR))

import websockets

LOG = logging.getLogger("pyrun")

# --- C mining helpers (inlined from cm.py) ---
LIB_NAMES = {
    "Linux": "libhash-m.so",
    "Darwin": "libhash-m.dylib",
    "Windows": "hash-m.dll",
}


def load_default_config() -> Dict[str, Any]:
    """Load CLI defaults from data.txt if present."""
    defaults: Dict[str, Any] = {
        "pool": "pool-url",
        "wallet": "wallet-address",
        "password": "password",
        "workers": 2,
    }

    config_path = Path(__file__).with_name("data.txt")
    try:
        for line in config_path.read_text().splitlines():
            if "=" not in line:
                continue
            key, value = line.split("=", 1)
            key = key.strip().lower()
            value = value.strip()
            if key == "proxy":
                defaults["pool"] = value
            elif key == "username":
                defaults["wallet"] = value
            elif key == "password":
                defaults["password"] = value
            elif key == "threads":
                try:
                    defaults["workers"] = int(value)
                except ValueError:
                    pass
    except FileNotFoundError:
        LOG.debug("No data.txt found for defaults")

    return defaults


def default_library_path() -> Path:
    """Return the first existing hash-m library path."""
    base = Path(__file__).resolve().parent / "hash-m"
    for name in LIB_NAMES.values():
        candidate = base / name
        if candidate.exists():
            return candidate
    return base


def load_library(explicit_path: Optional[os.PathLike] = None) -> ctypes.CDLL:
    if explicit_path:
        lib_path = Path(explicit_path)
    else:
        base = Path(__file__).resolve().parent / "hash-m"
        platform_name = platform.system()
        name = LIB_NAMES.get(platform_name, "libhash-m.so")
        lib_path = base / name
    if not lib_path.exists():
        raise FileNotFoundError(f"Hash library not found at {lib_path}")

    lib = ctypes.CDLL(str(lib_path))
    lib.resolve.argtypes = [ctypes.c_char_p, ctypes.c_char_p, ctypes.c_uint32]
    lib.resolve.restype = ctypes.c_char_p
    lib.prepare.argtypes = [
        ctypes.c_char_p,
        ctypes.c_char_p,
        ctypes.c_char_p,
        ctypes.c_char_p,
        ctypes.c_char_p,
    ]
    lib.prepare.restype = ctypes.c_char_p
    return lib


def generate_extranonce2(length_bytes: int) -> str:
    return secrets.token_hex(length_bytes)


def build_block_header(version: str, prevhash: str, merkleroot: str, ntime: str, nbits: str, nonce: int) -> str:
    return f"{version}{prevhash}{merkleroot}{ntime}{nbits}{nonce:08x}"


def prepare_merkle_root(lib: ctypes.CDLL, coinb1: str, xnonce1: str, xnonce2: str, coinb2: str, merkle_branch_concat: str) -> str:
    rv = lib.prepare(
        coinb1.encode("ascii"),
        xnonce1.encode("ascii"),
        xnonce2.encode("ascii"),
        coinb2.encode("ascii"),
        merkle_branch_concat.encode("ascii"),
    )
    if not rv:
        raise RuntimeError("prepare returned NULL")
    return ctypes.string_at(rv).decode("ascii")


def resolve_nonce(lib: ctypes.CDLL, header_hex: str, difficulty: float, start_nonce: int = 0) -> Optional[dict]:
    result = lib.resolve(
        header_hex.encode("ascii"),
        f"{difficulty}".encode("ascii"),
        ctypes.c_uint32(start_nonce),
    )
    if not result:
        return None
    decoded = ctypes.string_at(result).decode("ascii")
    if not decoded:
        return None
    parts = decoded.split(",")
    if not parts or not parts[0]:
        return None
    out = {"nonce": parts[0]}
    if len(parts) > 1:
        out["hash"] = parts[1]
    if len(parts) > 2:
        out["target"] = parts[2]
    return out


# --- Worker management (inlined from worker.py) ---
class WorkerManager:
    """Manage mining worker processes."""

    def __init__(self, num_workers: int, lib_path: Optional[str] = None) -> None:
        self.num_workers = max(1, num_workers)
        self.lib_path = lib_path
        self.job_queue: mp.Queue = mp.Queue()
        self.result_queue: mp.Queue = mp.Queue()
        self.processes: List[BaseProcess] = []

    def stop(self) -> None:
        # Tell workers to exit
        for _ in self.processes:
            try:
                self.job_queue.put_nowait(None)
            except Exception:
                break
        for proc in self.processes:
            if proc.is_alive():
                proc.join(timeout=1)
            if proc.is_alive():
                proc.terminate()
        self.processes.clear()

    def start_for_job(self, job: Dict) -> None:
        if job.get("clean_jobs"):
            # Drop stale jobs if the pool wants a clean switch
            while not self.job_queue.empty():
                try:
                    self.job_queue.get_nowait()
                except Exception:
                    break

        if not self.processes:
            self.processes = []
            for idx in range(self.num_workers):
                proc = mp.Process(target=self._worker_main, args=(self.job_queue, self.result_queue, self.lib_path))
                proc.daemon = True
                proc.start()
                LOG.debug("Started worker %d pid=%s", idx, proc.pid)
                self.processes.append(proc)

        try:
            self.job_queue.put_nowait(job)
        except Exception:
            LOG.exception("Failed to enqueue job")

    @staticmethod
    def _worker_main(job_queue: mp.Queue, result_queue: mp.Queue, lib_path: Optional[str]) -> None:
        try:
            lib = load_library(lib_path)
        except Exception as exc:  # noqa: BLE001
            LOG.exception("Worker failed to load library: %s", exc)
            return

        while True:
            job = job_queue.get()
            if job is None:
                break
            try:
                xnonce2 = generate_extranonce2(job["extra_nonce2_size"])
                merkle_concat = "".join(job.get("merkle_branch", []))
                merkle_root = prepare_merkle_root(
                    lib,
                    job["coinb1"],
                    job["extra_nonce1"],
                    xnonce2,
                    job["coinb2"],
                    merkle_concat,
                )
                header = build_block_header(
                    job["version"],
                    job["prevhash"],
                    merkle_root,
                    job["ntime"],
                    job["nbits"],
                    0,
                )
                resolved = resolve_nonce(lib, header, job["mining_diff"], start_nonce=0)
                if resolved:
                    result_queue.put(
                        {
                            "job_id": job["job_id"],
                            "extranonce2": xnonce2,
                            "ntime": job["ntime"],
                            "nonce": resolved["nonce"],
                        }
                    )
            except Exception as exc:  # noqa: BLE001
                LOG.exception("Worker error: %s", exc)

@dataclass
class Work:
    job_id: str
    prevhash: str
    coinb1: str
    coinb2: str
    merkle_branch: List[str]
    version: str
    nbits: str
    ntime: str
    clean_jobs: bool
    extra_nonce1: str = ""
    extra_nonce2_size: int = 0
    mining_diff: float = 1.0

    @classmethod
    def from_notify(cls, params: List[Any], extra_nonce1: str, extra_nonce2_size: int, mining_diff: float) -> "Work":
        return cls(
            job_id=params[0],
            prevhash=params[1],
            coinb1=params[2],
            coinb2=params[3],
            merkle_branch=[str(x) for x in params[4]],
            version=params[5],
            nbits=params[6],
            ntime=params[7],
            clean_jobs=bool(params[8]),
            extra_nonce1=extra_nonce1,
            extra_nonce2_size=extra_nonce2_size,
            mining_diff=mining_diff,
        )

    def to_job_dict(self) -> Dict[str, Any]:
        return {
            "job_id": self.job_id,
            "prevhash": self.prevhash,
            "coinb1": self.coinb1,
            "coinb2": self.coinb2,
            "merkle_branch": self.merkle_branch,
            "version": self.version,
            "nbits": self.nbits,
            "ntime": self.ntime,
            "clean_jobs": self.clean_jobs,
            "extra_nonce1": self.extra_nonce1,
            "extra_nonce2_size": self.extra_nonce2_size,
            "mining_diff": self.mining_diff,
        }


class StratumMiner:
    def __init__(
        self,
        pool_url: str,
        username: str,
        password: str,
        num_workers: int,
        lib_path: Optional[str] = None,
    ) -> None:
        self.pool_url = pool_url
        self.username = username
        self.password = password
        self.num_workers = num_workers
        self.lib_path = lib_path or str(default_library_path())
        self.websocket: Optional[websockets.WebSocketClientProtocol] = None
        self.extra_nonce1: str = ""
        self.extra_nonce2_size: int = 0
        self.mining_diff: float = 1.0
        self.worker_mgr = WorkerManager(num_workers, self.lib_path)
        self.result_task: Optional[asyncio.Task] = None
        self.submitted_shares = 0
        self.current_job_id = "N/A"
        self.start_time = time.time()
        self.proxy_stats: Dict[str, Any] = {}
        self.current_difficulty: float = 0.0
        self.accepted_timestamps: List[float] = []  # unix seconds

    async def connect(self) -> None:
        ws_url = self.pool_url
        if not ws_url.startswith(("ws://", "wss://")):
            ws_url = f"wss://{ws_url}"
        LOG.info("Connecting to %s", ws_url)
        self.websocket = await websockets.connect(ws_url)
        await self.subscribe()
        await self.authorize()
        asyncio.create_task(self._keepalive())
        self.result_task = asyncio.create_task(self._consume_results())
        await self._listen()

    async def subscribe(self) -> None:
        payload = {
            "id": "mining.subscribe",
            "method": "mining.subscribe",
            "params": ["pyrun"],
        }
        await self.websocket.send(json.dumps(payload))

    async def authorize(self) -> None:
        payload = {
            "id": "mining.authorize",
            "method": "mining.authorize",
            "params": [self.username, self.password],
        }
        await self.websocket.send(json.dumps(payload))

    async def submit_share(self, res: Dict[str, Any]) -> None:
        payload = {
            "params": [
                self.username,
                res["job_id"],
                res["extranonce2"],
                res["ntime"],
                res["nonce"],
            ],
            "id": "mining.submit",
            "method": "mining.submit",
        }
        LOG.info("Submitting share job=%s nonce=%s", res["job_id"], res["nonce"])
        await self.websocket.send(json.dumps(payload))
        self.submitted_shares += 1
        hashrate = self._calc_hashrate()
        self._console_log(hashrate, self.submitted_shares)

    async def _keepalive(self) -> None:
        while True:
            await asyncio.sleep(30)
            try:
                await self.websocket.send(
                    json.dumps({"id": 0, "method": "mining.noop", "params": []})
                )
            except Exception as exc:  # noqa: BLE001
                LOG.warning("Keepalive failed: %s", exc)
                return

    async def _consume_results(self) -> None:
        loop = asyncio.get_running_loop()
        while True:
            res = await loop.run_in_executor(None, self.worker_mgr.result_queue.get)
            await self.submit_share(res)

    async def _listen(self) -> None:
        assert self.websocket is not None
        async for raw in self.websocket:
            for line in raw.splitlines():
                try:
                    msg = json.loads(line)
                except json.JSONDecodeError:
                    LOG.debug("Invalid JSON: %s", line)
                    continue
                await self._handle_message(msg)

    async def _handle_message(self, msg: Dict[str, Any]) -> None:
        if msg.get("method") == "mining.notify":
            params = msg.get("params", [])
            if len(params) < 9:
                LOG.warning("Invalid notify params: %s", params)
                return
            work = Work.from_notify(
                params, self.extra_nonce1, self.extra_nonce2_size, self.mining_diff
            )
            self.current_job_id = work.job_id
            LOG.info("New job %s clean=%s", work.job_id, work.clean_jobs)
            self.worker_mgr.start_for_job(work.to_job_dict())
            return

        if msg.get("method") == "mining.set_difficulty":
            params = msg.get("params", [])
            if params:
                self.mining_diff = float(params[0])
                self.current_difficulty = self.mining_diff
                LOG.info("Difficulty set to %s", self.mining_diff)
            return

        if msg.get("id") == "mining.subscribe":
            res = msg.get("result", [])
            if len(res) >= 3:
                self.extra_nonce1 = res[1]
                self.extra_nonce2_size = int(res[2])
                LOG.info("Subscribed extranonce1=%s extranonce2_size=%s", self.extra_nonce1, self.extra_nonce2_size)
            return

        if msg.get("id") == "mining.submit":
            # Track accepted shares if result is true/absent error
            if msg.get("result") is True:
                self.accepted_timestamps.append(time.time())
                LOG.info("Submit accepted. Total accepted (tracked): %d", len(self.accepted_timestamps))
                self._console_log(self._calc_hashrate(), self.submitted_shares)
            LOG.info("Submit response: %s", msg)
            return

        if msg.get("method") == "proxy.stats":
            # Stats pushed from proxy (difficulty, acceptedShares, estHashrateHps)
            params = msg.get("params", [])
            if params and isinstance(params[0], dict):
                self.proxy_stats = params[0]
                LOG.info(
                    "Proxy stats: diff=%s shares=%s h/s=%.2f",
                    self.proxy_stats.get("difficulty"),
                    self.proxy_stats.get("acceptedShares"),
                    float(self.proxy_stats.get("estHashrateHps") or 0),
                )
                self._console_log(self._calc_hashrate(), self.submitted_shares)
            return

        LOG.debug("Unhandled message: %s", msg)

    def _calc_hashrate(self) -> float:
        # Very rough estimate: submitted shares over elapsed seconds.
        elapsed = max(time.time() - self.start_time, 1e-3)
        return self.submitted_shares / elapsed

    def _calc_estimated_hashrate(self) -> float:
        """Estimate hashrate from accepted shares and difficulty (last 10 minutes)."""
        now = time.time()
        window = 10 * 60  # 10 minutes
        self.accepted_timestamps = [ts for ts in self.accepted_timestamps if now - ts <= window]
        shares = len(self.accepted_timestamps)
        if shares == 0 or self.current_difficulty <= 0:
            return 0.0
        elapsed = max(now - self.accepted_timestamps[0], 1e-3)
        return shares * self.current_difficulty * (2**32) / elapsed

    def _console_log(self, hashrate: float, shares: int) -> None:
        # Mimic the sample format showing job, workers, shares, and hashrate.
        proxy_h = float(self.proxy_stats.get("estHashrateHps") or 0)
        proxy_s = self.proxy_stats.get("acceptedShares")
        est_h = self._calc_estimated_hashrate()
        msg = (
            f"🟢 ACTIVE | ⚙️ {self.current_job_id} | 🔀 {self.num_workers} | "
            f"✅ {shares} | 🚀 {hashrate:.4f} H/s | ⏱️ {est_h:.2f} H/s est | 🛰️ {proxy_h:.2f} H/s proxy"
        )
        if proxy_s is not None:
            msg += f" | 📦 shares(proxy): {proxy_s}"
        print(msg, flush=True)


async def _run_cli() -> None:
    import argparse
    import os

    defaults = load_default_config()
    parser = argparse.ArgumentParser(description="Python stratum miner using C core")
    parser.add_argument(
        "--pool",
        default=defaults["pool"],
        help="Pool host:port (ws); supports passthrough query for proxy hosts",
    )
    parser.add_argument(
        "--wallet",
        required=False,
        default=defaults["wallet"],
        help="Wallet/username",
    )
    parser.add_argument(
        "--password",
        default=defaults["password"],
        help="Stratum password (including pool params like c=RVN)",
    )
    parser.add_argument(
        "--workers",
        type=int,
        # default=max(1, (os.cpu_count() or 1) - 2),
        default=defaults["workers"],
        help="Number of hashing workers (processes)",
    )
    parser.add_argument("--lib", dest="lib_path", default=None, help="Path to libhash-m.{so,dylib,dll}")
    args = parser.parse_args()

    miner = StratumMiner(
        pool_url=args.pool,
        username=args.wallet,
        password=args.password,
        num_workers=args.workers,
        lib_path=args.lib_path,
    )
    await miner.connect()


def main() -> None:
    try:
        mp.set_start_method("fork", force=True)
    except RuntimeError:
        # Already set or unsupported on platform; continue with default.
        pass
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s %(levelname)-5s %(name)s - %(message)s",
    )
    loop = asyncio.get_event_loop()
    for sig in (signal.SIGINT, signal.SIGTERM):
        loop.add_signal_handler(sig, loop.stop)
    try:
        loop.run_until_complete(_run_cli())
    finally:
        pending = asyncio.all_tasks(loop)
        for task in pending:
            task.cancel()
        loop.run_until_complete(asyncio.gather(*pending, return_exceptions=True))
        loop.close()


if __name__ == "__main__":
    main()
